<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
  </head>
  <body>
    <h1>Spotify Top Songs & Artists</h1>
    <p id="textInput" value="">
      Choose year:
      <output for="mySlider" id="year">2020</output>
    </p>
    <input
      type="range"
      name="mySlider"
      id="mySlider"
      min="1920"
      max="2020"
      value="2020"
      style="margin: 0; width: 520px"
      step="1"
    />

    <table cellpadding='45'>
        <tr>
            <td> <div id="chart" style="width: 520px; height: 420px"></div></td>
            <td>  <div id="chart_artist" style="width: 520px; height: 420px"></div></td>
        </tr>
    </table>

<style>
       div.tooltip {
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        padding: 4px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
</style>
    <script>
      // Bubble chart for songs
      d3.csv("data/data.csv").then((allData) => {d3.csv("data/data_yearly_artist_popularity_cleaned.csv").then((allDataArtist) => {
        // Filter top 10 songs of 2020
        var year = "2020";
        d3.select("#mySlider").on("input", function (d) {
          selectedValue = this.value;
          document.getElementById("year").value = selectedValue;

          year = selectedValue.toString();
          // For song data
          const yearData = allData.filter((d) => d.year === year);
          var data = yearData
            .sort(function (a, b) {
              return d3.descending(+a.popularity, +b.popularity);
            })
            .slice(0, 10);
          update(dataAt(year));

            // For artist data
          const yearDataArtist = allDataArtist.filter((d) => d.year === year);
          var data = yearDataArtist
            .sort(function (a, b) {
              return d3.descending(+a.agg_popularity, +b.agg_popularity);
            })
            .slice(0, 10);
          updateArtist(dataAtArtist(year));
        });

        // Filter song data
        function dataAt(year) {
          const yearData = allData.filter((d) => d.year === year);
          var data = yearData
            .sort(function (a, b) {
              return d3.descending(+a.popularity, +b.popularity);
            })
            .slice(0, 10);

          var popularities = [];
          var min = 100;
          var max = 0;

          for (var i = 0; i < data.length; i++) {
            popularities.push(data[i].popularity);
          }

          min = popularities.sort(function (a, b) {
            return d3.descending(+a, +b);
          })[9];
          max = popularities.sort(function (a, b) {
            return d3.descending(+a, +b);
          })[0];

          data.forEach(function (d) {
            d.popularity_normalized =
              Math.abs(d.popularity - min) / (max - min);
          });
          return data;
        }
        var data = dataAt(year);

        // Filter artist data
        function dataAtArtist(year) {
          const yearDataArtist = allDataArtist.filter((d) => d.year === year);
          var dataArtist = yearDataArtist
            .sort(function (a, b) {
              return d3.descending(+a.agg_popularity, +b.agg_popularity);
            })
            .slice(0, 10);

          var popularities = [];
          var min = 100;
          var max = 0;

          for (var i = 0; i < dataArtist.length; i++) {
            popularities.push(dataArtist[i].agg_popularity);
          }
          min = popularities.sort(function (a, b) {
            return d3.descending(+a, +b);
          })[9];
          max = popularities.sort(function (a, b) {
            return d3.descending(+a, +b);
          })[0];
          dataArtist.forEach(function (d) {
            d.popularity_normalized =
              Math.abs(d.agg_popularity - min) / (max - min);
          });
          
          return dataArtist;
        }

        var dataArtist = dataAt(year);
        // Setting up variables that describe chart space
        const height = 400;
        const width = 520;
        const margin = { top: 10, right: 30, bottom: 30, left: 30 };

        var diameter = 600;
        var color = d3.scaleOrdinal(d3.schemeDark2);

        var bubble = d3.pack(data).size([diameter, diameter]).padding(3);
        var bubbleArtist = d3.pack(dataArtist).size([diameter, diameter]).padding(3);
        
        // svg song data
        var svg = d3
          .select("body")
          .append("svg")
          .attr("width", diameter)
          .attr("height", diameter)
          .attr("class", "bubble");

        d3.select(self.frameElement).style("height", diameter + "px");
        
        document.getElementById("chart").appendChild(svg.node());
        update(dataAt(year));


        // svg artist data
        var svgArtist = d3
          .select("body")
          .append("svg")
          .attr("width", diameter)
          .attr("height", diameter)
          .attr("class", "bubble");

        d3.select(self.frameElement).style("height", diameter + "px");
        
        document.getElementById("chart_artist").appendChild(svgArtist.node());
        updateArtist(dataAtArtist(year));

        function update(data) {
          var oldChild = document.getElementById("chart").lastElementChild;

          var svg = d3
            .select("body")
            .append("svg")
            .attr("width", diameter)
            .attr("height", diameter)
            .attr("class", "bubble");

          var nodes = d3.hierarchy({ children: data }).sum(function (d) {
            return d.popularity_normalized;
          });
          var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
          var node = svg
            .selectAll(".node")
            .data(bubble(nodes).descendants())
            .enter()
            .filter(function (d) {
              return !d.children;
            })
            .append("g")
            .attr("class", "node")
            .attr("transform", function (d) {
              return "translate(" + d.x + "," + d.y + ")";
            });

          node
            .append("circle")
            .attr("r", function (d) {
              return d.r;
            })
            .style("fill", function (d, i) {
              return color(i);
            })
            .on("mouseover", function(event, d) {
             tooltip.transition()
               .duration(200)
               .style("opacity", .9);
             tooltip.html("Song: " + d.data.name + "<br/> Artists: " + d.data.artists)
             
               .style("left", (event.pageX) + "px")
               .style("top", (event.pageY - 28) + "px");


             })
           .on("mouseout", function(event, d) {
             tooltip.transition()
               .duration(500)
               .style("opacity", 0);

            });

          node
            .append("text")
            .attr("dy", "1.3em")
            .style("text-anchor", "middle")

            .text(function (d) {
              return d.data.name;
            })
            .attr("font-family", "Gill Sans", "Gill Sans MT")
            .attr("font-size", function (d) {
              return d.r / 8;
            })
            .attr("fill", "black");

          document.getElementById("chart").replaceChild(svg.node(), oldChild);
        }

        // Update artist chart
        function updateArtist(data) {
        var oldChild = document.getElementById("chart_artist").lastElementChild;

        var svg = d3
          .select("body")
          .append("svg")
          .attr("width", diameter)
          .attr("height", diameter)
          .attr("class", "bubble");

        var nodes = d3.hierarchy({ children: data }).sum(function (d) {
          return d.popularity_normalized;
        });
        var tooltip = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0);
        var node = svg
          .selectAll(".node")
          .data(bubbleArtist(nodes).descendants())
          .enter()
          .filter(function (d) {
            return !d.children;
          })
          .append("g")
          .attr("class", "node")
          .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
          });

        node
          .append("circle")
          .attr("r", function (d) {
            return d.r;
          })
          .style("fill", function (d, i) {
            return color(i);
          })
          .on("mouseover", function(event, d) {
           tooltip.transition()
             .duration(200)
             .style("opacity", .9);
           tooltip.html("Artist: " + d.data.artist)
           
             .style("left", (event.pageX) + "px")
             .style("top", (event.pageY - 28) + "px");


           })
         .on("mouseout", function(event, d) {
           tooltip.transition()
             .duration(500)
             .style("opacity", 0);

          });

        node
          .append("text")
          .attr("dy", "1.3em")
          .style("text-anchor", "middle")

          .text(function (d) {
            return d.data.artist;
          })
          .attr("font-family", "Gill Sans", "Gill Sans MT")
          .attr("font-size", function (d) {
            return d.r / 8;
          })
          .attr("fill", "black");

        document.getElementById("chart_artist").replaceChild(svg.node(), oldChild);
      }
      });
    });

  </script>
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>
