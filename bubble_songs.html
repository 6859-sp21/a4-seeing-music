<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
  </head>
  <body>
    <h1>Bubble</h1>
    <p id="textInput" value=""> Choose year:
        <output for="mySlider" id="year">1920</output>
    </p>
    <input type="range" name="mySlider" id=mySlider min="1920" max="2020" value="50" style="margin: 0; width: 500px;" step="1">
    <div id="chart" style="width:520px;height:420px;">
      <!-- This is where we will put our chart. -->
    </div>


    <script>
      // Load data from a URL. You can also have the json file downloaded.
      // See https://github.com/d3/d3/blob/master/API.md#fetches-d3-fetch for more options.
      d3.csv("data/data.csv").then((allData) => {

      // Filter top 10 songs of 2020
      var year = '1920';
      d3.select("#mySlider").on("change", function(d){
          selectedValue = this.value
          document.getElementById('year').value=selectedValue;
          
          year = selectedValue.toString();
          const yearData = allData.filter(d => d.year === year);
        var data = yearData.sort(function(a, b) {
            return d3.descending(+a.popularity, +b.popularity);
        }).slice(0, 10);
          update(data);
    })

        const yearData = allData.filter(d => d.year === year);
        var data = yearData.sort(function(a, b) {
            return d3.descending(+a.popularity, +b.popularity);
        }).slice(0, 10);

        // var popularities = []
        // var min = 100
        // var max = 0

        // for (var i = 0; i < data.length; i++) {
        //     popularities.push(data[i].popularity);
        // }
        // console.log(popularities)

        // min = popularities.sort(function(a, b) {
        //     return d3.descending(+a, +b);})[9]
        // max = popularities.sort(function(a, b) {
        //     return d3.descending(+a, +b);})[0]

        // console.log(max)
        // console.log(min)
        // data.forEach(function(d) {
        //     d.popularity_normalized = Math.abs(d.popularity - min) / (max - min);
        // });




      // Setting up variables that describe chart space
      const height = 400;
      const width = 500;
      const margin = ({top: 10, right: 10, bottom: 20, left: 20});

      var diameter = 600;
      var color = d3.scaleOrdinal(d3.schemeDark2);

      //data =  d3.hierarchy().sum(d => d.popularity);
     
      var bubble = d3.pack(data)
          .size([diameter, diameter])
          .padding(1.5);

      var svg = d3.select("body")
          .append("svg")
          .attr("width", diameter)
          .attr("height", diameter)
          .attr("class", "bubble");
      
      var nodes = d3.hierarchy({children: data})
          .sum(function(d) {return (d.popularity); });

      var node = svg.selectAll(".node")
          .data(bubble(nodes).descendants())
          .enter()
          .filter(function(d){
              return  !d.children
          })
          .append("g")
          .attr("class", "node")
          .attr("transform", function(d) {
              return "translate(" + d.x + "," + d.y + ")";
          });
        
      node.append("title")
          .text(function(d) {
            //   return d.data.name + ": " + d.data.popularity;
            return d.data.name;
          });

      node.append("circle")
          .attr("r", function(d) {
              return d.r;
          })
          .style("fill", function(d,i) {
              return color(i);
          });

    //   node.append("text")
    //       .attr("dy", ".2em")
    //       .style("text-anchor", "middle")
    //       .text(function(d) {
    //           return d.data.popularity
    //       })
    //       .attr("font-family", "sans-serif")
    //       .attr("font-size", function(d){
    //           return d.r/5;
    //       })
    //       .attr("fill", "pink");

      node.append("text")
          .attr("dy", "1.3em")
          .style("text-anchor", "middle")
          .text(function(d) {
              return d.data.name;
          })
          .attr("font-family",  "Gill Sans", "Gill Sans MT")
          .attr("font-size", function(d){
              return d.r/7;
          })
          .attr("fill", "black");

      d3.select(self.frameElement)
          .style("height", diameter + "px");
        
      document.getElementById("chart").appendChild(svg.node());
      
      function update(data){

        var oldChild = document.getElementById("chart").lastElementChild;
        
        var popularities = []
        var min = 100
        var max = 0

        for (var i = 0; i < data.length; i++) {
            popularities.push(data[i].popularity);
        }
        console.log(popularities)

        min = popularities.sort(function(a, b) {
            return d3.descending(+a, +b);})[9]
        max = popularities.sort(function(a, b) {
            return d3.descending(+a, +b);})[0]

        console.log(max)
        console.log(min)
        data.forEach(function(d) {
            d.popularity_normalized = Math.abs(d.popularity - min) / (max - min);
        });

        var svg = d3.select("body")
          .append("svg")
          .attr("width", diameter)
          .attr("height", diameter)
          .attr("class", "bubble");
      
      var nodes = d3.hierarchy({children: data})
          .sum(function(d) { return d.popularity_normalized ; });

      var node = svg.selectAll(".node")
          .data(bubble(nodes).descendants())
          .enter()
          
          .filter(function(d){
              return  !d.children
          })
          .append("g")
          .attr("class", "node")
          .attr("transform", function(d) {
              return "translate(" + d.x + "," + d.y + ")";
          });

      node.append("title")
          .text(function(d) {
            //   return d.data.name + ": " + d.data.popularity;
              return d.data.name;
          });

      node.append("circle")
        //     .transition()
        // .duration(1000)
          .attr("r", function(d) {
              return d.r;
          })
          .style("fill", function(d,i) {
              return color(i);
          });

    //   node.append("text")
    //       .attr("dy", ".2em")
    //       .style("text-anchor", "middle")
    //       .text(function(d) {
    //           return d.data.popularity_normalized
    //       })
    //       .attr("font-family", "sans-serif")
    //       .attr("font-size", function(d){
    //           return d.r/5;
    //       })
    //       .attr("fill", "pink");

      node.append("text")
    //   .transition()
    //     .duration(1000)
          .attr("dy", "1.3em")
          .style("text-anchor", "middle")
          .text(function(d) {
              return d.data.name;
          })
          .attr("font-family",  "Gill Sans", "Gill Sans MT")
          .attr("font-size", function(d){
              return d.r/8;
          })
          .attr("fill", "black");
        
    //   d3.select(self.frameElement)
    //       .style("height", diameter + "px");
        document.getElementById("chart").replaceChild(svg.node(),oldChild);
       
      }
      
        
      });
  
      </script>
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>